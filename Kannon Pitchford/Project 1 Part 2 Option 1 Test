clear; clc; close all;

model = "P1S2sim";   % change if needed
tEnd  = 25;

% Parameters
J1 = 100; b1 = 1;
J2 = 1;   b2 = 1;

A_vals = [1, 100];
k_vals = [10, 100, 1000];

w10 = 0; w20 = 0;
th10 = 0; th20 = 0;

fixedSolvers = ["ode1","ode4"];
dt_vals = [0.1, 1];
varSolvers = ["ode45"];

% Push constants
assignin("base","J1",J1); assignin("base","b1",b1);
assignin("base","J2",J2); assignin("base","b2",b2);
assignin("base","w10",w10); assignin("base","w20",w20);
assignin("base","th10",th10); assignin("base","th20",th20);

% Results table
T2 = table();

for A = A_vals
    assignin("base","A",A);

    for k = k_vals
        assignin("base","k",k);

        % ---- Create ONE figure per (A,k) ----
        figure; hold on; grid on;
        xlabel("Time (s)");
        ylabel("\omega (rad/s)");
        title(sprintf("Option 1 Combined | A=%g Nm, k=%g", A, k));

        % Fixed-step
        for solver = fixedSolvers
            for dt = dt_vals
                set_param(model, "Solver", solver, "FixedStep", num2str(dt), "StopTime", num2str(tEnd));

                try
                    tic; out = sim(model); cpuTime = toc;

                    t  = out.w1.time;
                    w1 = out.w1.data;
                    w2 = out.w2.data;

                    % store
                    T2 = [T2; table(string(solver), dt, A, k, cpuTime, true, "", ...
                        {t},{w1},{w2}, 'VariableNames', ...
                        {'solver','dt','A','k','cpuTime','success','errMsg','t','w1','w2'})];

                    % plot (label)
                    lbl = sprintf("%s dt=%g", solver, dt);
                    plot(t, w1, "DisplayName", "w1 " + lbl);
                    plot(t, w2, "--", "DisplayName", "w2 " + lbl);

                catch ME
                    T2 = [T2; table(string(solver), dt, A, k, NaN, false, string(ME.message), ...
                        {[]},{[]},{[]}, 'VariableNames', ...
                        {'solver','dt','A','k','cpuTime','success','errMsg','t','w1','w2'})];
                end
            end
        end

        % Variable-step
        for solver = varSolvers
            set_param(model, "Solver", solver, "StopTime", num2str(tEnd));

            try
                tic; out = sim(model); cpuTime = toc;

                t  = out.w1.time;
                w1 = out.w1.data;
                w2 = out.w2.data;

                T2 = [T2; table(string(solver), NaN, A, k, cpuTime, true, "", ...
                    {t},{w1},{w2}, 'VariableNames', ...
                    {'solver','dt','A','k','cpuTime','success','errMsg','t','w1','w2'})];

                plot(t, w1, "DisplayName", "w1 " + string(solver));
                plot(t, w2, "--", "DisplayName", "w2 " + string(solver));

            catch ME
                T2 = [T2; table(string(solver), NaN, A, k, NaN, false, string(ME.message), ...
                    {[]},{[]},{[]}, 'VariableNames', ...
                    {'solver','dt','A','k','cpuTime','success','errMsg','t','w1','w2'})];
            end
        end

        legend("Location","bestoutside");
    end
end

CPU_Table = T2(T2.success==true, {'solver','dt','A','k','cpuTime'});
disp(CPU_Table);

save("P2_option1_results.mat","T2","CPU_Table");
writetable(CPU_Table,"P2_option1_CPUtimes.csv");
